# Подсистема аналитики средней скорости транспортного потока

## Описание задачи

Имеется комплекс фотовидеофиксации (КВФВ) и таких комплексов может быть больше 1 000, в комплексе есть сущность "Событие". (проезд транспортного средства в момент времени). Кол-во событий по 1 комплексу может превышать 1 000 000 за сутки, в сущности присутствуют разные поля в том числе:

- Время наступления события
- Скорость транспортного средства

Комплекс может только фиксировать и передавать данные. Предусмотреть что комплекс стоит на федеральных трассах, где плохая связь и данные могут приходить с большой задержкой (события произошли несколько часов назад, а пришли в систему только сейчас).

**Задача** спроектировать подсистему (выбрать средства хранения и доставки данных, нарисовать общую схему работы подсистемы), которая бы считала среднюю скорость потока для выбранного КВФВ в заданный промежуток времени 5 минут, 1 час, сутки. Необходимо выбрать стек, средства хранения и передачи данных»

## Формализация задачи

- Каждый КВФВ генерирует **до 1 млн событий в сутки**.
- Всего **>1000 КВФВ** → до **1 млрд событий в сутки**.
- Данные могут приходить **с задержкой (до нескольких часов)**.
- Нужно считать **среднюю скорость** по каждому КВФВ за **5 минут, 1 час, сутки**.
- Данные приходят с **временем события**, а не временем получения.

## **Предлагаемое архитектурное решение**

![Обобщенная схема](./doc/image.png "Обобщенная схема")


###  **1. Стек технологий**

| Назначение | Технология | Обоснование |
|----------|-----------|-----------|
| **Приём данных** | Kafka или Pulsar | Высокая пропускная способность, масштабируемость (у нас сценарии простые, предлагаю остановиться наKafka)|
| **Хранение сырых данных** | S3 + Apache Iceberg / Delta Lake | Масштабируемое, поддержка time travel, late data (предлагаю остановится на Apache Iceberg - поддержка Flink, без привязки к вендору) |
| **Стриминговая обработка** | Apache Flink | Отличная поддержка event-time, окон, обработка с задержкой (watermarks), stateful processing |
| **Хранение агрегатов** | ClickHouse / Druid | Высокая скорость агрегаций, оптимизация под аналитику (предлагаю остановиться на ClickHouse по причине точной агрегации - SUM, COUNT, AVG, DISTINCT и т.д.)|
| **API для запросов** | REST/gRPC сервис на Go/Java + кэш (Redis) | Быстрый доступ к предподсчитанным агрегатам (REST API будет проще в разработке и тетсировании, хотябы за счет того, что вебке не нужно будет работать с протобафом)|
| **Оркестрация** | Kubernetes + Helm | Масштабирование и управление |

---

## Материалы

Pulsar vs Kafka: сравнение и мифы https://habr.com/ru/companies/slurm/articles/548702/

Еще 5 причин выбрать Apache Pulsar вместо Apache Kafka https://habr.com/ru/articles/569406/